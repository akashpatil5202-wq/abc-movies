<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comic Pro: Ultimate Shapes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Kalam:wght@700&display=swap');
        body { overflow: hidden; position: fixed; width: 100%; height: 100%; background: #111; touch-action: none; }
        .comic-font { font-family: 'Bangers', cursive; }
        
        .canvas-area { 
            width: 95vw; height: 42vh; background: white; 
            border: 5px solid #000; position: relative; 
            margin: 5px auto; overflow: hidden; touch-action: none;
            background-size: cover; background-position: center;
        }

        .draggable-wrapper { position: absolute; cursor: move; touch-action: none; z-index: 10; display: inline-block; transform-origin: center; }

        .delete-btn {
            position: absolute; top: -15px; right: -15px; background: #ff4444; color: white; 
            border-radius: 50%; width: 26px; height: 26px; display: flex;
            align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
            border: 2px solid white; z-index: 5000;
        }

        /* --- Bubble Styles --- */
        .shape-classic { border: 3px solid #000; border-radius: 20px; padding: 10px; background: white; }
        .shape-cloud { border: 3px solid #000; border-radius: 50%; padding: 15px; background: white; }
        .shape-shout { border: 4px solid #000; padding: 10px; background: #ff0; clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 85% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 85% 100%, 15% 100%, 15% 85%, 0% 85%); }
        .shape-whisper { border: 2px dashed #666; border-radius: 30px; padding: 10px; background: rgba(255,255,255,0.8); font-style: italic; }
        .shape-robot { border: 3px solid #000; background: #000; color: #0f0 !important; padding: 10px; font-family: monospace; }
        .shape-shadow { border: 3px solid #000; background: white; padding: 10px; box-shadow: 8px 8px 0px rgba(0,0,0,0.2); }

        .bottom-menu {
            position: fixed; bottom: 0; width: 100%; height: 52vh;
            background: #1a1a1a; border-top: 5px solid #fbbf24;
            padding: 12px; border-radius: 30px 30px 0 0; overflow-y: auto;
        }
    </style>
</head>
<body>

    <div class="p-2 flex justify-between items-center px-4 bg-zinc-900">
        <button onclick="changePage(-1)" class="bg-zinc-700 text-white px-4 py-2 rounded-xl text-xs font-bold">PREV</button>
        <h1 class="comic-font text-xl text-yellow-400 italic">DESIGN STUDIO - PAGE <span id="pageNo">1</span></h1>
        <button onclick="changePage(1)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">NEXT</button>
    </div>

    <div id="comic-canvas" class="canvas-area"></div>

    <div class="bottom-menu">
        <div class="bg-zinc-800 p-3 rounded-2xl mb-3">
            <input type="text" id="diagMsg" placeholder="Baat likhein..." class="w-full p-2 rounded-xl text-black font-bold mb-3 outline-none border-2 border-yellow-500">
            
            <p class="text-[10px] text-yellow-500 font-bold mb-2 uppercase">Select Style:</p>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="addBubble('shape-classic')" class="bg-white text-[10px] font-bold py-2 rounded border-2 border-black">NORMAL</button>
                <button onclick="addBubble('shape-cloud')" class="bg-white text-[10px] font-bold py-2 rounded border-2 border-black">THOUGHT</button>
                <button onclick="addBubble('shape-shout')" class="bg-yellow-400 text-[10px] font-bold py-2 rounded border-2 border-black">SHOUT</button>
                <button onclick="addBubble('shape-whisper')" class="bg-gray-200 text-[10px] font-bold py-2 rounded border-2 border-black">WHISPER</button>
                <button onclick="addBubble('shape-robot')" class="bg-black text-green-400 text-[10px] font-bold py-2 rounded border-2 border-green-400">ROBOT</button>
                <button onclick="addBubble('shape-shadow')" class="bg-white text-[10px] font-bold py-2 rounded border-2 border-black shadow-md">MODERN</button>
            </div>

            <div class="flex gap-2">
                <input type="color" id="bgColor" value="#ffffff" class="flex-1 h-8 rounded">
                <input type="color" id="txtColor" value="#000000" class="flex-1 h-8 rounded">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="document.getElementById('charInp').click()" class="bg-blue-500 text-white p-3 rounded-xl font-bold text-[10px] uppercase">Add Character</button>
            <input type="file" id="charInp" hidden onchange="addAsset(event)">
            
            <button onclick="document.getElementById('bgInp').click()" class="bg-green-600 text-white p-3 rounded-xl font-bold text-[10px] uppercase">Add Background</button>
            <input type="file" id="bgInp" hidden onchange="addBackground(event)">
        </div>

        <button onclick="exportToDevice()" class="w-full mt-3 bg-yellow-400 text-black p-3 rounded-xl font-black text-xs uppercase border-2 border-black">Download This Page (PNG)</button>
        <button onclick="clearAll()" class="w-full mt-2 bg-red-600 text-white p-2 rounded-xl font-bold text-[10px] uppercase">Clear Everything</button>
    </div>

    <script>
        let currentPage = 1;
        let pagesData = {};
        let globalZIndex = 1000;

        // Load Data on Startup
        window.onload = () => {
            const saved = localStorage.getItem('comic_data_pro');
            if(saved) {
                pagesData = JSON.parse(saved);
                loadPageContent();
            }
        };

        function saveCurrentState() {
            pagesData[currentPage] = {
                html: document.getElementById('comic-canvas').innerHTML,
                bg: document.getElementById('comic-canvas').style.backgroundImage
            };
            localStorage.setItem('comic_data_pro', JSON.stringify(pagesData));
        }

        function loadPageContent() {
            const canvas = document.getElementById('comic-canvas');
            canvas.innerHTML = pagesData[currentPage]?.html || "";
            canvas.style.backgroundImage = pagesData[currentPage]?.bg || "";
            document.getElementById('pageNo').innerText = currentPage;
            
            // Re-attach events to loaded elements
            document.querySelectorAll('.draggable-wrapper').forEach(el => initActions(el));
        }

        function addBubble(style) {
            const msg = document.getElementById('diagMsg').value || "Hello!";
            const bbl = document.createElement('div');
            bbl.className = style + " font-bold text-center";
            bbl.innerText = msg;
            if(style !== 'shape-robot') {
                bbl.style.backgroundColor = document.getElementById('bgColor').value;
                bbl.style.color = document.getElementById('txtColor').value;
            }
            document.getElementById('comic-canvas').appendChild(createWrapper(bbl));
            document.getElementById('diagMsg').value = "";
            saveCurrentState();
        }

        function createWrapper(el) {
            const wrapper = document.createElement('div');
            wrapper.className = "draggable-wrapper";
            const del = document.createElement('div');
            del.className = "delete-btn"; del.innerHTML = "X";
            del.onclick = (e) => { e.stopPropagation(); wrapper.remove(); saveCurrentState(); };
            wrapper.appendChild(del);
            wrapper.appendChild(el);
            wrapper.style.left = "20px"; wrapper.style.top = "20px";
            initActions(wrapper);
            return wrapper;
        }

        function addAsset(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.createElement('img');
                img.src = ev.target.result; img.className = "w-32";
                document.getElementById('comic-canvas').appendChild(createWrapper(img));
                saveCurrentState();
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function addBackground(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('comic-canvas').style.backgroundImage = `url(${ev.target.result})`;
                saveCurrentState();
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function initActions(el) {
            let active = false, currentX = 0, currentY = 0, initialX, initialY, xOff = 0, yOff = 0, scale = 1, lastDist = 0;

            const start = (e) => {
                active = true; globalZIndex++; el.style.zIndex = globalZIndex;
                let cx = (e.touches) ? e.touches[0].clientX : e.clientX;
                let cy = (e.touches) ? e.touches[0].clientY : e.clientY;
                initialX = cx - xOff; initialY = cy - yOff;
            };

            const move = (e) => {
                if (active && (!e.touches || e.touches.length === 1)) {
                    let cx = (e.touches) ? e.touches[0].clientX : e.clientX;
                    let cy = (e.touches) ? e.touches[0].clientY : e.clientY;
                    currentX = cx - initialX; currentY = cy - initialY;
                    xOff = currentX; yOff = currentY;
                    el.style.transform = `translate3d(${currentX}px, ${currentY}px, 0) scale(${scale})`;
                }
                if (e.touches && e.touches.length === 2) {
                    let dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    if (lastDist > 0) {
                        scale += (dist - lastDist) / 150;
                        scale = Math.min(Math.max(0.3, scale), 5);
                        el.style.transform = `translate3d(${currentX}px, ${currentY}px, 0) scale(${scale})`;
                    }
                    lastDist = dist;
                }
            };

            el.addEventListener("touchstart", start, {passive:false});
            document.addEventListener("touchmove", move, {passive:false});
            document.addEventListener("touchend", () => { active = false; lastDist = 0; saveCurrentState(); });
            el.addEventListener("mousedown", start);
            document.addEventListener("mousemove", move);
            document.addEventListener("mouseup", () => { active = false; saveCurrentState(); });
        }

        function changePage(step) {
            saveCurrentState();
            if (currentPage + step < 1) return;
            currentPage += step;
            loadPageContent();
        }

        function exportToDevice() {
            const canvas = document.getElementById('comic-canvas');
            // Hide delete buttons for photo
            document.querySelectorAll('.delete-btn').forEach(b => b.style.display = 'none');

            html2canvas(canvas, { useCORS: true, backgroundColor: null }).then(canvasImg => {
                const link = document.createElement('a');
                link.download = `my-comic-page-${currentPage}.png`;
                link.href = canvasImg.toDataURL("image/png");
                link.click();
                document.querySelectorAll('.delete-btn').forEach(b => b.style.display = 'flex');
            });
        }

        function clearAll() {
            if(confirm("Kya aap poora data delete karna chahte hain?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>